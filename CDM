DECLARE FCH_HOY DATE DEFAULT CURRENT_DATE('America/Mexico_City');
DECLARE FCH_INI DATE DEFAULT (DATE_ADD(DATE_TRUNC(FCH_HOY, YEAR),INTERVAL -10 YEAR));

WITH 
EXT_VFAC_NEGFIN_CBSUM AS (
  SELECT *
  FROM (
    SELECT 
      SV_LOGO AS LOGO, 
      SV_APIA_TYPE AS BR_TIPO, 
      SV_APLIC AS APLIC, 
      SV_APIA_STORE_NUM AS TIENDA,
      SV_APIA_AGE AS EDAD, 
      SV_APIA_BIRTH_DATE AS FCHA_NAC,  
      SV_APIA_GENDER AS GENERO, 
      SV_APIA_NUM_DEP AS NO_DEPENDIENTES,
      SV_APIA_EDO_CIV AS EDO_CIV,
      SV_APIA_TIPO_VIV AS TPO_VIV,
      SV_APIA_ZIP_CODE AS CDP, 
      SV_APIA_TIME_RES AS TIEMPO_RESID, 
      SV_APIA_FLAG_SADD AS APIA_FLAG_SADD, 
      SV_APIA_INCOME_TIT AS APIA_INCOME,
      SV_APIA_TIME_EMP_TIT AS APIA_TIME_EMP, 
      SV_APIA_ZIP_JOB_TIT AS APIA_ZIP_EMP,	
      SV_APIA_TITLE_JOB_TIT AS APIA_TITLE_JOB,	
      SV_FLAG_HIT	AS FLAG_HIT,
      SV_BC_MAX_MOP_ACT AS BC_MAX_MOP_ACT,	
      SV_BC_MAX_MOP_GVE AS BC_MAX_MOP_GVE, 
      SV_NUM_ACC_MOP5_24M AS  NUM_ACC_MOP5_24M,	
      SV_NUM_ACC_OPEN_12M AS NUM_ACC_OPEN_12M, 	
      SV_NUM_ACC_OPEN AS NUM_ACC_OPEN,	
      SV_NUM_ACC_OPEN_6M AS NUM_ACC_OPEN_6M,	
      SV_COUNT_ACC_OPEN AS COUNT_ACC_OPEN,	
      SV_COUNT_MOP3_12M AS COUNT_MOP3_12M,	
      SV_CLIENTE_LIV AS CTE_LIV,	
      SV_ACC_100_UTIL AS ACC_100_UTIL, 	
      SV_MONTH_CONS AS MONTH_CONS,	
      SV_MAX_UTILZ AS   MAX_UTILIZA,	
      SV_MAX_MOP_ACT AS MAX_MOP_ACT,	
      SV_MAX_MOP_GVE AS MAX_MOP_GCE,	
      SV_MAX_ANTIG_REV AS MAX_ANTIG_REV,	
      SV_RATIO_CTAS_6M AS RATIO_CTAS_6M,	
      SV_RATIO_MOP3_12M AS RATIO_MOP3_12M,	
      SV_RATIO_SDO_VEN AS RATIO_SDO_VENC,	
      SV_AVG_UTIL_REV AS AVG_UTIL_REV,	
      SV_AVG_LIM_CRED_VAL AS AVG_LIM_CRED_VAL,	
      SV_NW_FLAG_HIT AS NW_FLAG_HIT,	
      SV_AVG_UTIL_SIN_LIV AS AVG_UTIL_SIN_LIV,	
      SV_AVG_ANTG_TOT_CTAS AS AVG_ANTIG_TOT_CTAS,	
      SV_AVG_MON_MAX_MORA AS AVG_MON_MORA,	
      SV_COUNT_MPO1_6M AS COUNT_MOP1_6M,	
      SV_COUNT_TOTAL_CTAS AS COUNT_TOTAL_CTAS,	
      SV_SUM_BAL_OPEN_6M AS SUM_BAL_OPEN_6M,	
      SV_SUM_BAL_OPEN_TOT AS SUM_BAL_OPEN_TOT,	          
      SV_MAX_HIGH_BAL AS MAX_HICH_BAL,	
      SV_MAX_SDO_GVE AS MAX_SDO_GVE,  
      SV_RANK_1_LC AS RANK_1_LC,	
      SV_RANK_2_LC AS RANK_2_LC, 	
      SV_NUM_CONS_9M AS NUM_CONS_9M,	
      SV_MAX_MOP_REP_3M AS SUM_NOP_REP_3M,	
      SV_COUNT_MOP4_REP_12M AS COUNT_MOP_REP_12M,	
      SV_COUNT_CTAS_REP_12M AS COUNT_CTAS_REP_12M,	
      SV_MAX_MOP_GVE_GLOBAL AS MAX_MOP_GVE_GLOBAL,	
      SV_SUM_CTAS_PF AS SUM_CTAS_PF,	
      SV_CTAS_OPEN AS SUM_CTAS_OPEN,	
      SV_CTAS_HIP AS SUM_CTAS_HIP,	
      SV_CTAS_REV AS SUM_CTAS_REV,
      SV_S1_DECISION AS S1_DECISION,	
      SV_S1_HIT_IND AS ID_HIT, 
      SV_S1_SEGUNDA_LC_PROM_2 AS LDC_PROM,	
      SV_S1_ID_CUT_OFF AS ID_CUTOFF,	
      SV_S1_CREDIT_LIMIT AS LIM_CRED,	
      SV_S1_ID_CRED_LIM AS ID_LIM_CRED, 		
      SV_S1_MESSAGE_0	AS MESSAGE_0,
      SV_S1_MESSAGE_1 AS MESSAGE_1,	
      SV_S1_MESSAGE_2	AS MESSAGE_2,
      SV_S1_SCORE_CODE AS SCORE_CODE,	
      SV_S1_SCORE_RAW AS SCORE_RAW_SCORE,                  
      SV_S1_SCORE_ALIGN_SCO AS SCORE_ALIGNED_SCORE, 
      SV_S1_SCO_FAC_0 AS SCORE_SCORE_FACTOR_0,	
      SV_S1_SCO_FAC_1 AS SCORE_SCORE_FACTOR_1,	
      SV_S1_SCO_FAC_2 AS SCORE_SCORE_FACTOR_2,	
      SV_S1_TASA AS S1_TASA,	
      ANO_SOL,	
      DIA_SOL,	
      ROW_UUID,	
      FCH_CARGA, 
      SV_SUM_LIM_CRED_4MIL AS SUM_LIM_CRED4M,
      SV_MAX_MOP_REP_3M AS MAX_MOP_REP_3M,
      SV_MAX_HIGH_BAL AS MAX_HIGH_BAL, 
      SV_RANK_2_LC AS RANK_LC_2,
      PARSE_DATE('%Y%j', SUBSTR(CAST(SV_APLIC AS STRING), 1, 7)) AS DT_FCH_SOL,
      FORMAT_DATE("%Y%m", PARSE_DATE('%Y%j', SUBSTR(CAST(SV_APLIC AS STRING), 1, 7))) DT_FEC_SOL,
      IF(SV_APIA_TIPO_VIV IN (1, 2, 3), SV_APIA_TIPO_VIV, 0) AS BR_TIPO_VIVIENDA_CVE,
      IF(SV_S1_MESSAGE_2 IN ('PEDIR COMPROBANTE DE INGRESOS','PEDIR INGRESOS PARA INCREMENTAR LC','REVISAR DOCTOS E INGRESOS', 
                             'SOLICITAR ENTREGA A DOMICILIO','SOLICITAR INGRESOS PARA INCREMENTAR LC','SOLICITAR VISITA', 
                             'VALIDAR DOCUMENTOS E INGRESOS','BLOQ TARJETA Y SOLICITAR DOCTOS O VISITA')
        ,1 ,0) AS FLG_VERIF_DOC,
      CASE 
        WHEN SV_S1_SCORE_CODE IN ('HIT_DIL_17', 'HIT_DILISA', 'HIT_LPC', 'HIT_DILISA_1', 'HIT_LPC_DIL_', 
                                  'HIT_LPC_PUR_', 'HIT_SUB_Emp_', 'HitSubDobles', 'HitSubPuro', 'Hit_Suburbia') THEN 'HIT'
        WHEN SV_S1_SCORE_CODE IN('TF_DILISA_16', 
                                 'TFSuburbia') THEN 'THIN FILE'
        WHEN SV_S1_SCORE_CODE IN ('NO_HIT_LPC_1','NO_DILISA_16','NO_HIT', 
                                  'NOHIT_Suburb','NoHitSubVisa','NoHitSuburbi') THEN 'NOHIT'
        ELSE 'SIN HIT' 
      END BR_HIT_DES,
      CASE 
        WHEN SV_S1_DECISION = 'acp' THEN 'APPROVE'
        WHEN SV_S1_DECISION = 'rec' THEN 'DECLINE'
        WHEN SV_S1_DECISION = 'ana' THEN 'INVESTIGATE'
        ELSE 'NO DECISION' 
      END BR_STT_CRED_DES,
      CASE 
        WHEN SV_S1_MESSAGE_0 ='CLIENTE LIVERPOOL MAL PAGADOR' OR 
             SV_S1_MESSAGE_2 ='CLIENTE LIVERPOOL MAL PAGADOR' THEN 'HISTORIAL CREDITICIO INTERNO (ON-US)'
        WHEN SV_S1_MESSAGE_2 = 'MAL BURO PREVIO' THEN 'HISTORIAL CREDITICIO SOCIEDADES DE INFORMACIÓN (OFF-US)'
        WHEN SV_S1_MESSAGE_2 ='NO CUMPLE REQUERIMIENTOS MINIMOS' THEN 'POLÍTICAS DE ACEPTACIÓN'
        WHEN SV_S1_MESSAGE_0 IN('ESTRATEGIA INVALIDA (NOHIT LPC)', 'ESTRATEGIA INVALIDA(NOHITSUB_VIS') THEN 'POLÍTICAS DE ACEPTACIÓN'
        WHEN SV_S1_MESSAGE_2 = 'CLIENTE MENOS DE 3M O DOBLE CAPTURA' THEN 'POLÍTICAS DE ACEPTACIÓN'
        WHEN SV_S1_MESSAGE_2 = 'CLIENTE MENOS DE 6M O DOBLE CAPTURA' THEN 'POLÍTICAS DE ACEPTACIÓN'
        WHEN SV_S1_MESSAGE_2 = 'CUENTA CERRADA MENOR A 18 MESES' THEN 'POLÍTICAS DE ACEPTACIÓN'
        WHEN SV_S1_MESSAGE_2 = 'CTE NO HIT MENOS DE 6 MESES EN LIVERPOOL' THEN 'POLÍTICAS DE ACEPTACIÓN'
        WHEN SV_S1_MESSAGE_2 IN('CTE NO HIT MAS DE 2 INTENTOS - ANALIZAR', 'CTE NO HIT MAS DE 2 INTENTOS 6M') THEN 'POLÍTICAS DE ACEPTACIÓN'
        WHEN SV_S1_MESSAGE_2 IN('PEDIR COMPROBANTE DE INGRESOS', 'PEDIR INGRESOS PARA INCREMENTAR LC', 'REVISAR DOCTOS E INGRESOS',
            'SOLICITAR ENTREGA A DOMICILIO', 'SOLICITAR INGRESOS PARA INCREMENTAR LC', 'SOLICITAR VISITA', 'VALIDAR DOCUMENTOS E INGRESOS',
            'BLOQ TARJETA Y SOLICITAR DOCTOS O VISITA') THEN 'PROCESO DICTAMINACIÓN'
        WHEN SV_S1_MESSAGE_0 IN('PUNTAJE DE SCORE NO SUFICIENTE', 'PUNTOS ABAJO DEL CUT_OFF') OR 
             SV_S1_MESSAGE_1 = 'PUNTAJE DE SCORE NO SUFICIENTE' THEN 'SCORE'
        ELSE 'SIN DICTAMEN' 
      END AS BR_DICTAMEN_DES,
      CASE 
        WHEN SV_S1_MESSAGE_2 ='CLIENTE LIVERPOOL MAL PAGADOR' OR 
             SV_S1_MESSAGE_2='CLIENTE LIVERPOOL MAL PAGADOR' THEN 'CUENTA CON ATRASO +60 DÍAS'
        WHEN SV_S1_MESSAGE_2 = 'MAL BURO PREVIO' THEN 'CUENTA CON ATRASO +90 DÍAS'
        WHEN SV_S1_MESSAGE_2 ='NO CUMPLE REQUERIMIENTOS MINIMOS' THEN 'DOBLE CAPTURA'
        WHEN SV_S1_MESSAGE_0 IN('ESTRATEGIA INVALIDA (NOHIT LPC)', 'ESTRATEGIA INVALIDA(NOHITSUB_VIS') THEN 'ESTRATEGIA NO VÁLIDA NO HIT VISA'
        WHEN SV_S1_MESSAGE_2 = 'CLIENTE MENOS DE 3M O DOBLE CAPTURA' THEN 'CUENTA NUEVA MENOR A 3 MESES'
        WHEN SV_S1_MESSAGE_2 = 'CLIENTE MENOS DE 6M O DOBLE CAPTURA' THEN 'CUENTA NUEVA MENOR A 6 MESES'
        WHEN SV_S1_MESSAGE_2 = 'CUENTA CERRADA MENOR A 18 MESES' THEN 'CUENTA CANCELADA MENOR A 18 MESES'
        WHEN SV_S1_MESSAGE_2 = 'CTE NO HIT MENOS DE 6 MESES EN LIVERPOOL' THEN 'CUENTA NUEVA MENOR A 6 MESES'
        WHEN SV_S1_MESSAGE_2 IN('CTE NO HIT MAS DE 2 INTENTOS - ANALIZAR', 'CTE NO HIT MAS DE 2 INTENTOS 6M') THEN 'DOBLE CAPTURA'
        WHEN SV_S1_MESSAGE_2 IN('PEDIR COMPROBANTE DE INGRESOS', 'PEDIR INGRESOS PARA INCREMENTAR LC', 'REVISAR DOCTOS E INGRESOS',
            'SOLICITAR ENTREGA A DOMICILIO', 'SOLICITAR INGRESOS PARA INCREMENTAR LC', 'SOLICITAR VISITA', 'VALIDAR DOCUMENTOS E INGRESOS',
            'BLOQ TARJETA Y SOLICITAR DOCTOS O VISITA') THEN 'VERIFICACIÓN TELEFÓNICA'
        WHEN SV_S1_MESSAGE_0 IN('PUNTAJE DE SCORE NO SUFICIENTE', 'PUNTOS ABAJO DEL CUT_OFF') OR 
             SV_S1_MESSAGE_1 = 'PUNTAJE DE SCORE NO SUFICIENTE' THEN 'SCORE INSUFICIENTE'
      END AS BR_REGLA_DES,
      ROW_NUMBER() OVER(PARTITION BY SV_APLIC ORDER BY FCH_CARGA DESC) AS rn
    FROM crp-pro-dwh-semanticagold.MUS_PRO_DWH_VIEWS_ODS.VFAC_NEGFIN_CBSUM
    WHERE PARSE_DATE('%Y%j', SUBSTR(CAST(SV_APLIC AS STRING), 1, 7)) >= FCH_INI
    ) a
  WHERE rn =1
),

EXT_VFAC_NEGFIN_CBSUM_COMPLETO_2018 AS (
  SELECT
    *
  FROM (
    SELECT
      *,
      ROW_NUMBER() OVER (PARTITION BY SV_LOGO, SV_APLIC, SV_APIA_TYPE ORDER BY DT_FCH_SOL) AS rn
    FROM (
      SELECT
          *,
          PARSE_DATE('%Y%j', SUBSTR(CAST(SV_APLIC AS STRING), 1, 7)) AS DT_FCH_SOL,
          SAFE_DIVIDE(SV_VARIABLE_CONSULTA_1, SV_COUNT_TOTAL_CTAS) AS BR_PCT_CTA_INACTIV
      FROM crp-pro-dwh-semanticagold.MUS_PRO_DWH_VIEWS_ODS.VFAC_NEGFIN_CBSUM_COMPLETO_2018
      WHERE PARSE_DATE('%Y%j', SUBSTR(CAST(SV_APLIC AS STRING), 1, 7)) >= FCH_INI
      UNION ALL
      SELECT
          *,
          PARSE_DATE('%Y%j', SUBSTR(CAST(SV_APLIC AS STRING), 1, 7)) AS DT_FCH_SOL,
          SAFE_DIVIDE(SV_VARIABLE_CONSULTA_1, SV_COUNT_TOTAL_CTAS) AS BR_PCT_CTA_INACTIV
      FROM crp-pro-dwh-semanticagold.MUS_PRO_DWH_VIEWS_ODS.VFAC_NEGFIN_CBSUM_COMPLETO_2018_NW
      WHERE PARSE_DATE('%Y%j', SUBSTR(CAST(SV_APLIC AS STRING), 1, 7)) >= FCH_INI
    )
  )
  WHERE rn=1
),

AUX_VFAC_NEGFIN_CBSUM AS (
  SELECT 
    a.*,
    b.SEGMENTO_C AS POBLA_NIVELC_CDP,
    b.ING_MENOR_2SM AS NUM_FAM_ING_MENOR_2SM_CDP,
    b.MORA_150_MAS AS AVG_GENTE_MORA150_CDP,
    b.MORA_120_MAS AS AVG_GENTE_MORA120_CDP,
    b.VIGENTES AS AVG_TOTAL_CRED_CDP,
    c.SV_VARIABLE_CONSULTA_2, c.SV_VARIABLE_CONSULTA_3,
    c.SV_VARIABLE_CONSULTA_4, c.SV_VAR_SCORE_2, 
    c.BR_PCT_CTA_INACTIV, c.SV_VAR_SCORE_1, c.SV_MONTH_CONS,
    c.SV_NUM_CONS_30D_LIV, c.SV_CONS_PP_LAST_3M,
  FROM EXT_VFAC_NEGFIN_CBSUM a
  LEFT JOIN crp-pro-dwh-semanticagold.MUS_PRO_DWH_VIEWS_ODS.VFAC_NEGFIN_LMRC_BUDDAFINAL b
  ON a.CDP = b.APIA_ZIP_CODE
  LEFT JOIN EXT_VFAC_NEGFIN_CBSUM_COMPLETO_2018 c
  ON a.APLIC = c.SV_APLIC AND a.BR_TIPO = c.SV_APIA_TYPE
),

SCR_VFAC_NEGFIN_CBSUM AS (
  SELECT 
    *,
    CASE 
      WHEN SCORE_CODE IN ('HIT_DILISA','HIT_LPC') THEN 'Hit Dilisa 2012'
      WHEN SCORE_CODE IN ('HIT_DIL_17','HIT_SUB_Emp_','HitSubDobles','HitSubPuro','Hit_Suburbia') THEN 'Hit Dilisa 2017'
      WHEN SCORE_CODE IN ('HIT_LPC_DIL_','HIT_LPC_PUR_') THEN 'Hit LPC 2016'
      WHEN SCORE_CODE IN ('NO_HIT_LPC_1','NO_DILISA_16','NOHIT_Suburb','NoHitSubVisa','NoHitSuburbi') THEN 'No Hit 2016'
      WHEN SCORE_CODE IN ('TFSuburbia','TF_DILISA_16') THEN 'Thin File 2016'
      WHEN SCORE_CODE = 'NO_HIT' THEN 'No Hit 2012'
      ELSE 'No identificado'
    END AS SCORECARD,
    CASE 
      WHEN SCORE_CODE IN ('HIT_DILISA','HIT_LPC') THEN EDAD
      WHEN SCORE_CODE IN ('HIT_DIL_17','HIT_SUB_Emp_','HitSubDobles','HitSubPuro','Hit_Suburbia') THEN AVG_UTIL_REV
      WHEN SCORE_CODE IN ('HIT_LPC_DIL_','HIT_LPC_PUR_') THEN EDAD
      WHEN SCORE_CODE IN ('NO_HIT_LPC_1','NO_DILISA_16','NOHIT_Suburb','NoHitSubVisa','NoHitSuburbi') THEN EDAD
      WHEN SCORE_CODE IN ('TFSuburbia','TF_DILISA_16') THEN EDAD
    END AS SC_N_VAR_01,
    CASE 
      WHEN SCORE_CODE IN ('HIT_DILISA','HIT_LPC') THEN RATIO_MOP3_12M
      WHEN SCORE_CODE IN ('HIT_DIL_17','HIT_SUB_Emp_','HitSubDobles','HitSubPuro','Hit_Suburbia') THEN NUM_ACC_OPEN_6M
      WHEN SCORE_CODE IN ('HIT_LPC_DIL_','HIT_LPC_PUR_')  THEN MAX_UTILIZA
      WHEN SCORE_CODE IN ('NO_HIT_LPC_1','NO_DILISA_16','NOHIT_Suburb','NoHitSubVisa','NoHitSuburbi') THEN APIA_INCOME
      WHEN SCORE_CODE IN ('TFSuburbia','TF_DILISA_16') THEN NUM_ACC_OPEN_12M
    END AS SC_N_VAR_02,
    CASE 
      WHEN SCORE_CODE IN ('HIT_DILISA','HIT_LPC') THEN NUM_ACC_MOP5_24M
      WHEN SCORE_CODE IN ('HIT_DIL_17','HIT_SUB_Emp_','HitSubDobles','HitSubPuro','Hit_Suburbia') THEN BC_MAX_MOP_GVE
      WHEN SCORE_CODE IN ('HIT_LPC_DIL_','HIT_LPC_PUR_') THEN AVG_UTIL_SIN_LIV
      WHEN SCORE_CODE IN ('NO_HIT_LPC_1','NO_DILISA_16','NOHIT_Suburb','NoHitSubVisa','NoHitSuburbi') THEN SUM_CTAS_PF
      WHEN SCORE_CODE IN ('TFSuburbia','TF_DILISA_16') THEN MAX_UTILIZA
    END AS SC_N_VAR_03,
    CASE 
      WHEN SCORE_CODE IN ('HIT_DILISA','HIT_LPC') THEN MAX_MOP_GCE
      WHEN SCORE_CODE IN ('HIT_DIL_17','HIT_SUB_Emp_','HitSubDobles','HitSubPuro','Hit_Suburbia') THEN SV_VARIABLE_CONSULTA_2
      WHEN SCORE_CODE IN ('HIT_LPC_DIL_','HIT_LPC_PUR_') THEN MAX_ANTIG_REV
      WHEN SCORE_CODE IN ('NO_HIT_LPC_1','NO_DILISA_16','NOHIT_Suburb','NoHitSubVisa','NoHitSuburbi') THEN RANK_1_LC
      WHEN SCORE_CODE IN ('TFSuburbia','TF_DILISA_16') THEN SUM_BAL_OPEN_TOT
    END AS SC_N_VAR_04,
    CASE 
      WHEN SCORE_CODE IN ('HIT_DILISA','HIT_LPC') THEN MAX_MOP_ACT
      WHEN SCORE_CODE IN ('HIT_DIL_17','HIT_SUB_Emp_','HitSubDobles','HitSubPuro','Hit_Suburbia') THEN SV_VARIABLE_CONSULTA_3
      WHEN SCORE_CODE IN ('HIT_LPC_DIL_','HIT_LPC_PUR_') THEN NUM_CONS_9M
      WHEN SCORE_CODE IN ('NO_HIT_LPC_1','NO_DILISA_16','NOHIT_Suburb','NoHitSubVisa','NoHitSuburbi') THEN APIA_TIME_EMP
      WHEN SCORE_CODE IN ('TFSuburbia','TF_DILISA_16') THEN BC_MAX_MOP_GVE
    END AS SC_N_VAR_05,
    CASE 
      WHEN SCORE_CODE IN ('HIT_DILISA','HIT_LPC') THEN ACC_100_UTIL
      WHEN SCORE_CODE IN ('HIT_DIL_17','HIT_SUB_Emp_','HitSubDobles','HitSubPuro','Hit_Suburbia') THEN SV_VARIABLE_CONSULTA_4
      WHEN SCORE_CODE IN ('HIT_LPC_DIL_','HIT_LPC_PUR_')  THEN AVG_UTIL_REV
      WHEN SCORE_CODE IN ('NO_HIT_LPC_1','NO_DILISA_16','NOHIT_Suburb','NoHitSubVisa','NoHitSuburbi') THEN NUM_CONS_9M
      WHEN SCORE_CODE IN ('TFSuburbia','TF_DILISA_16')    THEN COUNT_TOTAL_CTAS
    END AS SC_N_VAR_06,
    CASE 
      WHEN SCORE_CODE IN ('HIT_DILISA','HIT_LPC') THEN MAX_UTILIZA
      WHEN SCORE_CODE IN ('HIT_DIL_17','HIT_SUB_Emp_','HitSubDobles','HitSubPuro','Hit_Suburbia') THEN SV_VAR_SCORE_2
      WHEN SCORE_CODE IN ('HIT_LPC_DIL_','HIT_LPC_PUR_')  THEN NUM_ACC_OPEN_12M
      WHEN SCORE_CODE IN ('NO_HIT_LPC_1','NO_DILISA_16','NOHIT_Suburb','NoHitSubVisa','NoHitSuburbi') THEN COUNT_ACC_OPEN
      WHEN SCORE_CODE IN ('TFSuburbia','TF_DILISA_16')    THEN TIEMPO_RESID
    END AS SC_N_VAR_07,
    CASE 
      WHEN SCORE_CODE IN ('HIT_DILISA','HIT_LPC') THEN AVG_UTIL_REV
      WHEN SCORE_CODE IN ('HIT_DIL_17','HIT_SUB_Emp_','HitSubDobles','HitSubPuro','Hit_Suburbia') THEN BR_PCT_CTA_INACTIV
      WHEN SCORE_CODE IN ('HIT_LPC_DIL_','HIT_LPC_PUR_') THEN MAX_MOP_REP_3M
      WHEN SCORE_CODE IN ('NO_HIT_LPC_1','NO_DILISA_16','NOHIT_Suburb','NoHitSubVisa','NoHitSuburbi') THEN AVG_GENTE_MORA150_CDP
      WHEN SCORE_CODE IN ('TFSuburbia','TF_DILISA_16')    THEN APIA_INCOME
    END AS SC_N_VAR_08,
    CASE
      WHEN SCORE_CODE IN ('HIT_DILISA','HIT_LPC') THEN NUM_ACC_OPEN_12M
      WHEN SCORE_CODE IN ('HIT_DIL_17','HIT_SUB_Emp_','HitSubDobles','HitSubPuro','Hit_Suburbia') THEN SUM_LIM_CRED4M
      WHEN SCORE_CODE IN ('HIT_LPC_DIL_','HIT_LPC_PUR_') THEN MAX_HIGH_BAL
      WHEN SCORE_CODE IN ('NO_HIT_LPC_1','NO_DILISA_16','NOHIT_Suburb','NoHitSubVisa','NoHitSuburbi') THEN TIEMPO_RESID
      WHEN SCORE_CODE IN ('TFSuburbia','TF_DILISA_16') THEN RANK_1_LC
    END AS SC_N_VAR_09,
    CASE 
      WHEN SCORE_CODE IN ('HIT_DILISA','HIT_LPC') THEN RATIO_CTAS_6M
      WHEN SCORE_CODE IN ('HIT_DIL_17','HIT_SUB_Emp_','HitSubDobles','HitSubPuro','Hit_Suburbia') THEN SV_VAR_SCORE_1
      WHEN SCORE_CODE IN ('HIT_LPC_DIL_','HIT_LPC_PUR_') THEN SUM_CTAS_PF
      WHEN SCORE_CODE IN ('NO_HIT_LPC_1','NO_DILISA_16','NOHIT_Suburb','NoHitSubVisa','NoHitSuburbi') THEN TPO_VIV
      WHEN SCORE_CODE IN ('TFSuburbia','TF_DILISA_16') THEN AVG_GENTE_MORA120_CDP
    END AS SC_N_VAR_10,
    CASE 
      WHEN SCORE_CODE IN ('HIT_DILISA','HIT_LPC') THEN MAX_ANTIG_REV
      WHEN SCORE_CODE IN ('HIT_LPC_DIL_','HIT_LPC_PUR_') THEN RATIO_CTAS_6M
      WHEN SCORE_CODE IN ('NO_HIT_LPC_1','NO_DILISA_16','NOHIT_Suburb','NoHitSubVisa','NoHitSuburbi') THEN NO_DEPENDIENTES
      WHEN SCORE_CODE IN ('TFSuburbia','TF_DILISA_16') THEN AVG_TOTAL_CRED_CDP
    END AS SC_N_VAR_11,
    CASE 
      WHEN SCORE_CODE IN ('HIT_DILISA','HIT_LPC') THEN SV_MONTH_CONS
      WHEN SCORE_CODE IN ('HIT_LPC_DIL_','HIT_LPC_PUR_') THEN MAX_MOP_GVE_GLOBAL
      WHEN SCORE_CODE IN ('NO_HIT_LPC_1','NO_DILISA_16','NOHIT_Suburb','NoHitSubVisa','NoHitSuburbi') THEN POBLA_NIVELC_CDP
      WHEN SCORE_CODE IN ('TFSuburbia','TF_DILISA_16') THEN NO_DEPENDIENTES
    END AS SC_N_VAR_12,
    CASE 
      WHEN SCORE_CODE IN ('HIT_DILISA','HIT_LPC') THEN RATIO_SDO_VENC
      WHEN SCORE_CODE IN ('HIT_LPC_DIL_','HIT_LPC_PUR_') THEN COUNT_TOTAL_CTAS
      WHEN SCORE_CODE IN ('TFSuburbia','TF_DILISA_16') THEN NUM_FAM_ING_MENOR_2SM_CDP
    END AS SC_N_VAR_13,
    CASE 
      WHEN SCORE_CODE IN ('HIT_LPC_DIL_','HIT_LPC_PUR_')  THEN MAX_SDO_GVE
    END AS SC_N_VAR_14,
    CASE 
      WHEN SCORE_CODE IN ('HIT_LPC_DIL_','HIT_LPC_PUR_')  THEN RANK_LC_2
    END AS SC_N_VAR_15,
    CASE 
      WHEN SCORE_CODE IN ('HIT_LPC_DIL_','HIT_LPC_PUR_')  THEN RANK_1_LC
    END AS SC_N_VAR_16,
    CASE 
      WHEN SCORE_CODE IN ('HIT_LPC_DIL_','HIT_LPC_PUR_')  THEN SUM_LIM_CRED4M
    END AS SC_N_VAR_17,
    CASE 
      WHEN SCORE_CODE IN ('HIT_LPC_DIL_','HIT_LPC_PUR_')  THEN AVG_MON_MORA
    END AS SC_N_VAR_18
FROM AUX_VFAC_NEGFIN_CBSUM
)

SELECT
  *
FROM SCR_VFAC_NEGFIN_CBSUM
